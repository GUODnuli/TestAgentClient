╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Plan to implement                                                                                                                                                                                                           │
│                                                                                                                                                                                                                             │
│ MCP-AutoTest Backend Refactoring Plan                                                                                                                                                                                       │
│                                                                                                                                                                                                                             │
│ Overview                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                             │
│ 将 Python FastAPI 后端重构为 Node.js Fastify，引入 PostgreSQL + Redis + MainAgent/SubAgent 架构。                                                                                                                           │
│ Python Agent 代码（AgentScope、tools）保留为子进程，由 Node.js 服务编排。                                                                                                                                                   │
│                                                                                                                                                                                                                             │
│ New Project Structure                                                                                                                                                                                                       │
│                                                                                                                                                                                                                             │
│ mcp-autotest/                                                                                                                                                                                                               │
│ ├── server/                          # Node.js Fastify 后端（新）                                                                                                                                                           │
│ │   ├── package.json                                                                                                                                                                                                        │
│ │   ├── tsconfig.json                                                                                                                                                                                                       │
│ │   ├── .env / .env.example                                                                                                                                                                                                 │
│ │   ├── prisma/                                                                                                                                                                                                             │
│ │   │   ├── schema.prisma                                                                                                                                                                                                   │
│ │   │   └── migrations/                                                                                                                                                                                                     │
│ │   └── src/                                                                                                                                                                                                                │
│ │       ├── index.ts                 # 入口                                                                                                                                                                                 │
│ │       ├── app.ts                   # Fastify 工厂                                                                                                                                                                         │
│ │       ├── config/                                                                                                                                                                                                         │
│ │       │   ├── index.ts             # 环境变量配置                                                                                                                                                                         │
│ │       │   ├── database.ts          # Prisma 客户端单例                                                                                                                                                                    │
│ │       │   ├── redis.ts             # ioredis + BullMQ                                                                                                                                                                     │
│ │       │   └── logger.ts            # Pino 日志                                                                                                                                                                            │
│ │       ├── plugins/                                                                                                                                                                                                        │
│ │       │   ├── auth.ts              # JWT 验证插件                                                                                                                                                                         │
│ │       │   ├── cors.ts                                                                                                                                                                                                     │
│ │       │   ├── socket-io.ts                                                                                                                                                                                                │
│ │       │   ├── rate-limit.ts                                                                                                                                                                                               │
│ │       │   └── error-handler.ts                                                                                                                                                                                            │
│ │       ├── modules/                                                                                                                                                                                                        │
│ │       │   ├── auth/                                                                                                                                                                                                       │
│ │       │   │   ├── auth.routes.ts                                                                                                                                                                                          │
│ │       │   │   ├── auth.service.ts                                                                                                                                                                                         │
│ │       │   │   ├── auth.schemas.ts                                                                                                                                                                                         │
│ │       │   │   └── jwt.service.ts                                                                                                                                                                                          │
│ │       │   ├── chat/                                                                                                                                                                                                       │
│ │       │   │   ├── chat.routes.ts                                                                                                                                                                                          │
│ │       │   │   ├── chat.service.ts                                                                                                                                                                                         │
│ │       │   │   ├── chat.schemas.ts                                                                                                                                                                                         │
│ │       │   │   └── sse.handler.ts                                                                                                                                                                                          │
│ │       │   ├── conversation/                                                                                                                                                                                               │
│ │       │   │   ├── conversation.routes.ts                                                                                                                                                                                  │
│ │       │   │   ├── conversation.service.ts                                                                                                                                                                                 │
│ │       │   │   └── conversation.schemas.ts                                                                                                                                                                                 │
│ │       │   ├── task/                                                                                                                                                                                                       │
│ │       │   │   ├── task.routes.ts                                                                                                                                                                                          │
│ │       │   │   ├── task.service.ts                                                                                                                                                                                         │
│ │       │   │   └── task.schemas.ts                                                                                                                                                                                         │
│ │       │   ├── report/                                                                                                                                                                                                     │
│ │       │   │   ├── report.routes.ts                                                                                                                                                                                        │
│ │       │   │   └── report.service.ts                                                                                                                                                                                       │
│ │       │   └── hook/                                                                                                                                                                                                       │
│ │       │       ├── hook.routes.ts    # Agent 回调端点                                                                                                                                                                      │
│ │       │       └── hook.service.ts                                                                                                                                                                                         │
│ │       ├── agent/                                                                                                                                                                                                          │
│ │       │   ├── agent-manager.ts     # MainAgent: 生命周期编排                                                                                                                                                              │
│ │       │   ├── process-spawner.ts   # 子进程创建                                                                                                                                                                           │
│ │       │   ├── message-queue.ts     # Redis 消息队列                                                                                                                                                                       │
│ │       │   └── types.ts                                                                                                                                                                                                    │
│ │       ├── socket/                                                                                                                                                                                                         │
│ │       │   ├── socket-manager.ts                                                                                                                                                                                           │
│ │       │   └── namespaces.ts                                                                                                                                                                                               │
│ │       ├── storage/                                                                                                                                                                                                        │
│ │       │   ├── storage.service.ts                                                                                                                                                                                          │
│ │       │   └── path-validator.ts                                                                                                                                                                                           │
│ │       ├── cache/                                                                                                                                                                                                          │
│ │       │   ├── cache.service.ts                                                                                                                                                                                            │
│ │       │   └── cache-keys.ts                                                                                                                                                                                               │
│ │       └── common/                                                                                                                                                                                                         │
│ │           ├── errors.ts                                                                                                                                                                                                   │
│ │           ├── types.ts                                                                                                                                                                                                    │
│ │           └── utils.ts                                                                                                                                                                                                    │
│ ├── agent/                           # Python Agent（从 backend/agent/ 迁移）                                                                                                                                               │
│ │   ├── main.py                      # SubAgent 入口（基本不变）                                                                                                                                                            │
│ │   ├── hook.py                      # 回调钩子（保留 /trpc/* 路径）                                                                                                                                                        │
│ │   ├── tool_registry.py                                                                                                                                                                                                    │
│ │   ├── model.py                                                                                                                                                                                                            │
│ │   ├── args.py                                                                                                                                                                                                             │
│ │   ├── plan/                                                                                                                                                                                                               │
│ │   ├── tool/                                                                                                                                                                                                               │
│ │   └── utils/                                                                                                                                                                                                              │
│ ├── frontend/                        # 不变                                                                                                                                                                                 │
│ ├── config/                          # Agent TOML 配置                                                                                                                                                                      │
│ ├── prompts/                         # 系统提示词（从 backend/prompts/ 迁移）                                                                                                                                               │
│ ├── storage/                         # 运行时文件存储                                                                                                                                                                       │
│ ├── logs/                                                                                                                                                                                                                   │
│ ├── scripts/                                                                                                                                                                                                                │
│ │   ├── migrate-sqlite-to-pg.ts      # 数据迁移脚本                                                                                                                                                                         │
│ │   └── seed.ts                                                                                                                                                                                                             │
│ ├── docker-compose.yml               # PostgreSQL + Redis                                                                                                                                                                   │
│ └── requirements.txt                 # Python 依赖                                                                                                                                                                          │
│                                                                                                                                                                                                                             │
│ 删除: 整个 backend/ 目录（功能全部由 server/ + agent/ 承接）                                                                                                                                                                │
│                                                                                                                                                                                                                             │
│ ---                                                                                                                                                                                                                         │
│ Prisma Schema (PostgreSQL)                                                                                                                                                                                                  │
│                                                                                                                                                                                                                             │
│ datasource db {                                                                                                                                                                                                             │
│   provider = "postgresql"                                                                                                                                                                                                   │
│   url      = env("DATABASE_URL")                                                                                                                                                                                            │
│ }                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                             │
│ model User {                                                                                                                                                                                                                │
│   id, username (unique), email, passwordHash,                                                                                                                                                                               │
│   displayName, role (USER/ADMIN), status (ACTIVE/INACTIVE/BANNED),                                                                                                                                                          │
│   createdAt, updatedAt, lastLoginAt                                                                                                                                                                                         │
│   → conversations[], tasks[], agentSessions[]                                                                                                                                                                               │
│ }                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                             │
│ model Conversation {                                                                                                                                                                                                        │
│   id, userId (FK→User), title,                                                                                                                                                                                              │
│   createdAt, updatedAt                                                                                                                                                                                                      │
│   → messages[], agentSessions[]                                                                                                                                                                                             │
│   索引: userId, createdAt                                                                                                                                                                                                   │
│ }                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                             │
│ model Message {                                                                                                                                                                                                             │
│   id, conversationId (FK→Conversation), role, content (Text),                                                                                                                                                               │
│   metadata (Json), createdAt                                                                                                                                                                                                │
│   索引: conversationId, createdAt                                                                                                                                                                                           │
│   级联删除: Conversation 删除时同步删除                                                                                                                                                                                     │
│ }                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                             │
│ model Task {                                                                                                                                                                                                                │
│   id, userId (FK→User), taskType, status,                                                                                                                                                                                   │
│   parameters (Json), result (Json), checkpoint (Json),                                                                                                                                                                      │
│   errorMessage, timestamps                                                                                                                                                                                                  │
│   索引: taskType, status, userId, createdAt                                                                                                                                                                                 │
│ }                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                             │
│ model AgentSession {    // 新增：追踪 SubAgent 进程                                                                                                                                                                         │
│   id, conversationId (FK), userId (FK),                                                                                                                                                                                     │
│   replyId (unique), agentType (CHAT/PLAN/EXECUTOR/REVIEW),                                                                                                                                                                  │
│   status (STARTING/RUNNING/COMPLETED/FAILED/CANCELLED),                                                                                                                                                                     │
│   pid, metadata (Json), startedAt, finishedAt, errorMessage                                                                                                                                                                 │
│   索引: conversationId, replyId, status                                                                                                                                                                                     │
│ }                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                             │
│ ---                                                                                                                                                                                                                         │
│ MainAgent / SubAgent Architecture                                                                                                                                                                                           │
│                                                                                                                                                                                                                             │
│ ┌─────────────────────────────────────────────────────────┐                                                                                                                                                                 │
│ │ MainAgent (Node.js Fastify)                             │                                                                                                                                                                 │
│ │                                                         │                                                                                                                                                                 │
│ │  AgentManager                                           │                                                                                                                                                                 │
│ │  ├── processes: Map<replyId, ChildProcess>              │                                                                                                                                                                 │
│ │  ├── conversationAgents: Map<convId, Set<replyId>>      │                                                                                                                                                                 │
│ │  │                                                      │                                                                                                                                                                 │
│ │  ├── spawnAgent(params) → replyId                       │                                                                                                                                                                 │
│ │  ├── terminateAgent(replyId)                            │                                                                                                                                                                 │
│ │  ├── terminateConversation(convId) // 批量终止          │                                                                                                                                                                 │
│ │  └── getConversationAgents(convId) // 查询并行 Agent    │                                                                                                                                                                 │
│ │                                                         │                                                                                                                                                                 │
│ │  通信:                                                  │                                                                                                                                                                 │
│ │  ├── Server → SubAgent: child_process.spawn + stdin     │                                                                                                                                                                 │
│ │  └── SubAgent → Server: HTTP POST /trpc/* (hook 回调)   │                                                                                                                                                                 │
│ └──────────┬──────────────────────────────────────────────┘                                                                                                                                                                 │
│            │ spawn (可并行多个)                                                                                                                                                                                             │
│            ▼                                                                                                                                                                                                                │
│ ┌─────────────────────────────────────┐                                                                                                                                                                                     │
│ │ SubAgent (Python subprocess)        │  × N (并行)                                                                                                                                                                         │
│ │                                     │                                                                                                                                                                                     │
│ │  ReActAgent (AgentScope)            │                                                                                                                                                                                     │
│ │  ├── 专属 AgentType (Chat/Plan/...) │                                                                                                                                                                                     │
│ │  ├── 独立 InMemoryMemory           │                                                                                                                                                                                      │
│ │  ├── 独立 Toolkit                   │                                                                                                                                                                                     │
│ │  └── Hook → HTTP POST 增量推送      │                                                                                                                                                                                     │
│ └─────────────────────────────────────┘                                                                                                                                                                                     │
│                                                                                                                                                                                                                             │
│ 并行支持: 每个 Conversation 可同时运行多个 SubAgent（通过不同 replyId 区分），AgentManager 按 replyId 路由消息。                                                                                                            │
│                                                                                                                                                                                                                             │
│ ---                                                                                                                                                                                                                         │
│ Redis Usage                                                                                                                                                                                                                 │
│ ┌────────────────┬─────────────────────────────────┬─────────┬───────────────────────────┐                                                                                                                                  │
│ │      用途      │           Key Pattern           │   TTL   │        解决的问题         │                                                                                                                                  │
│ ├────────────────┼─────────────────────────────────┼─────────┼───────────────────────────┤                                                                                                                                  │
│ │ 用户会话       │ session:{userId}                │ 24h     │ 单点登录、JWT 黑名单      │                                                                                                                                  │
│ ├────────────────┼─────────────────────────────────┼─────────┼───────────────────────────┤                                                                                                                                  │
│ │ 会话列表缓存   │ cache:conversations:{userId}    │ 5min    │ 切换聊天加载慢            │                                                                                                                                  │
│ ├────────────────┼─────────────────────────────────┼─────────┼───────────────────────────┤                                                                                                                                  │
│ │ 消息缓存       │ cache:messages:{convId}         │ 1min    │ 频繁切换时减少 DB 查询    │                                                                                                                                  │
│ ├────────────────┼─────────────────────────────────┼─────────┼───────────────────────────┤                                                                                                                                  │
│ │ Agent 回复状态 │ agent:reply:{replyId}           │ 1h      │ 替代内存 _pending_replies │                                                                                                                                  │
│ ├────────────────┼─────────────────────────────────┼─────────┼───────────────────────────┤                                                                                                                                  │
│ │ Agent 消息累积 │ agent:messages:{replyId} (List) │ 1h      │ SSE 流式消费              │                                                                                                                                  │
│ ├────────────────┼─────────────────────────────────┼─────────┼───────────────────────────┤                                                                                                                                  │
│ │ 限流           │ ratelimit:{ip}:{endpoint}       │ sliding │ API 保护                  │                                                                                                                                  │
│ └────────────────┴─────────────────────────────────┴─────────┴───────────────────────────┘                                                                                                                                  │
│ BullMQ Queues:                                                                                                                                                                                                              │
│ - agent:spawn — 控制并发 spawn 数（concurrency: 5）                                                                                                                                                                         │
│ - agent:message — Hook 消息处理（concurrency: 50）                                                                                                                                                                          │
│                                                                                                                                                                                                                             │
│ ---                                                                                                                                                                                                                         │
│ API Compatibility (Frontend Zero Change)                                                                                                                                                                                    │
│                                                                                                                                                                                                                             │
│ 所有端点路径、请求/响应格式保持完全一致：                                                                                                                                                                                   │
│                                                                                                                                                                                                                             │
│ - POST /auth/{register,login,logout} / GET /auth/me                                                                                                                                                                         │
│ - POST /api/chat/{send,stream,upload,interrupt}                                                                                                                                                                             │
│ - CRUD /api/conversations + /api/conversations/:id/messages                                                                                                                                                                 │
│ - CRUD /api/tasks                                                                                                                                                                                                           │
│ - GET /api/reports/:taskId                                                                                                                                                                                                  │
│ - POST /trpc/pushMessageToChatAgent (Agent hook)                                                                                                                                                                            │
│ - POST /trpc/pushFinishedSignalToChatAgent (Agent hook)                                                                                                                                                                     │
│                                                                                                                                                                                                                             │
│ SSE 事件格式不变: data: {json}\n\n，事件类型: start, chunk, thinking, plan_update, testcases, error, done                                                                                                                   │
│                                                                                                                                                                                                                             │
│ Socket.IO 不变: namespace /client，事件 pushReplies, pushReplyingState, pushFinished, pushCancelled                                                                                                                         │
│                                                                                                                                                                                                                             │
│ 响应字段保持 snake_case: conversation_id, user_id, message_id, created_at                                                                                                                                                   │
│                                                                                                                                                                                                                             │
│ ---                                                                                                                                                                                                                         │
│ Implementation Phases                                                                                                                                                                                                       │
│                                                                                                                                                                                                                             │
│ Phase 1: Infrastructure Setup                                                                                                                                                                                               │
│                                                                                                                                                                                                                             │
│ - 创建 docker-compose.yml（PostgreSQL 16 + Redis 7）                                                                                                                                                                        │
│ - 初始化 server/ 目录：npm init, tsconfig.json                                                                                                                                                                              │
│ - 安装依赖：fastify, prisma, ioredis, bullmq, socket.io, pino, zod, bcryptjs, jsonwebtoken                                                                                                                                  │
│ - 编写 Prisma schema，运行 prisma migrate dev                                                                                                                                                                               │
│ - 创建 .env / .env.example                                                                                                                                                                                                  │
│                                                                                                                                                                                                                             │
│ 关键文件: server/package.json, server/tsconfig.json, server/prisma/schema.prisma, docker-compose.yml                                                                                                                        │
│                                                                                                                                                                                                                             │
│ Phase 2: Core Server Skeleton                                                                                                                                                                                               │
│                                                                                                                                                                                                                             │
│ - src/app.ts — Fastify 工厂（插件注册）                                                                                                                                                                                     │
│ - src/index.ts — 启动入口                                                                                                                                                                                                   │
│ - src/config/ — 配置、DB、Redis、Logger                                                                                                                                                                                     │
│ - src/plugins/ — CORS、错误处理                                                                                                                                                                                             │
│ - GET /health 健康检查                                                                                                                                                                                                      │
│ - 验证启动、连接 DB/Redis                                                                                                                                                                                                   │
│                                                                                                                                                                                                                             │
│ 关键文件: server/src/app.ts, server/src/index.ts, server/src/config/*.ts                                                                                                                                                    │
│                                                                                                                                                                                                                             │
│ Phase 3: Auth Module                                                                                                                                                                                                        │
│                                                                                                                                                                                                                             │
│ - JWT 服务（create/verify/decode）— 移植自 backend/auth/jwt_handler.py                                                                                                                                                      │
│ - Auth 服务（register/login/logout/changePassword）— 移植自 backend/auth/service.py                                                                                                                                         │
│ - Redis SessionManager                                                                                                                                                                                                      │
│ - Zod 验证 schemas                                                                                                                                                                                                          │
│ - Auth 路由（/auth/*）                                                                                                                                                                                                      │
│ - authenticate preHandler 插件                                                                                                                                                                                              │
│                                                                                                                                                                                                                             │
│ 源文件: backend/auth/service.py, backend/auth/jwt_handler.py, backend/auth/routes.py, backend/auth/dependencies.py                                                                                                          │
│                                                                                                                                                                                                                             │
│ Phase 4: Conversation & Message Module                                                                                                                                                                                      │
│                                                                                                                                                                                                                             │
│ - Conversation CRUD（Prisma）— 移植自 backend/agent/conversation_routes.py                                                                                                                                                  │
│ - Message CRUD                                                                                                                                                                                                              │
│ - Redis 缓存：会话列表 + 消息                                                                                                                                                                                               │
│ - 响应格式 snake_case 转换                                                                                                                                                                                                  │
│ - 性能测试：缓存 vs 无缓存的会话切换速度                                                                                                                                                                                    │
│                                                                                                                                                                                                                             │
│ 源文件: backend/agent/conversation_routes.py, backend/common/database.py (conversation/message 部分)                                                                                                                        │
│                                                                                                                                                                                                                             │
│ Phase 5: Socket.IO Integration                                                                                                                                                                                              │
│                                                                                                                                                                                                                             │
│ - Socket.IO 插件注册到 Fastify                                                                                                                                                                                              │
│ - /client namespace 处理                                                                                                                                                                                                    │
│ - SocketManager: broadcast 方法                                                                                                                                                                                             │
│ - joinChatRoom / leaveChatRoom 事件                                                                                                                                                                                         │
│                                                                                                                                                                                                                             │
│ 源文件: backend/service/agent_service.py (SocketManager 部分)                                                                                                                                                               │
│                                                                                                                                                                                                                             │
│ Phase 6: Agent Manager & Hook Endpoints                                                                                                                                                                                     │
│                                                                                                                                                                                                                             │
│ - process-spawner.ts — child_process.spawn 启动 Python Agent                                                                                                                                                                │
│   - CLI args + stdin 传递 query（同当前模式）                                                                                                                                                                               │
│   - stdout/stderr 日志捕获                                                                                                                                                                                                  │
│   - 环境变量 PYTHONIOENCODING=utf-8                                                                                                                                                                                         │
│ - agent-manager.ts — MainAgent 生命周期编排                                                                                                                                                                                 │
│   - 支持多 SubAgent 并行（per conversation）                                                                                                                                                                                │
│   - 优雅终止（SIGTERM → 5s → SIGKILL）                                                                                                                                                                                      │
│   - 服务关闭时清理所有进程                                                                                                                                                                                                  │
│ - Hook 路由：/trpc/pushMessageToChatAgent, /trpc/pushFinishedSignalToChatAgent                                                                                                                                              │
│ - Hook 服务：消息累积、testcase 提取                                                                                                                                                                                        │
│ - Agent 状态存储到 Redis（替代内存 _pending_replies）                                                                                                                                                                       │
│ - AgentSession 记录到 PostgreSQL                                                                                                                                                                                            │
│                                                                                                                                                                                                                             │
│ 源文件: backend/agent/chat_service.py (AgentProcessManager, ChatService), backend/agent/hook.py                                                                                                                             │
│                                                                                                                                                                                                                             │
│ Phase 7: Chat Module & SSE Streaming                                                                                                                                                                                        │
│                                                                                                                                                                                                                             │
│ - chat.service.ts — send_message, send_message_streaming                                                                                                                                                                    │
│ - sse.handler.ts — 使用 reply.raw 实现 SSE                                                                                                                                                                                  │
│   - 事件：start, chunk, thinking, plan_update, testcases, error, done, heartbeat                                                                                                                                            │
│ - POST /api/chat/stream — SSE 端点                                                                                                                                                                                          │
│ - POST /api/chat/send — 非流式端点                                                                                                                                                                                          │
│ - POST /api/chat/upload — 文件上传（@fastify/multipart）                                                                                                                                                                    │
│ - POST /api/chat/interrupt — 终止 Agent                                                                                                                                                                                     │
│ - Hook 消息 → SSE queue + Socket.IO broadcast 联动                                                                                                                                                                          │
│                                                                                                                                                                                                                             │
│ 源文件: backend/service/agent_service.py (chat endpoints), backend/agent/chat_service.py (streaming logic)                                                                                                                  │
│                                                                                                                                                                                                                             │
│ Phase 8: Task, Report & Storage                                                                                                                                                                                             │
│                                                                                                                                                                                                                             │
│ - Task CRUD — 移植自 backend/common/database.py (task 部分)                                                                                                                                                                 │
│ - Report 端点                                                                                                                                                                                                               │
│ - StorageService — 移植自 backend/common/storage.py                                                                                                                                                                         │
│ - 路径安全验证                                                                                                                                                                                                              │
│                                                                                                                                                                                                                             │
│ Phase 9: Python Agent Migration                                                                                                                                                                                             │
│                                                                                                                                                                                                                             │
│ - backend/agent/ → agent/（顶层目录）                                                                                                                                                                                       │
│ - 更新 agent/main.py 的 sys.path 和 import 路径                                                                                                                                                                             │
│ - 更新 agent/hook.py 的 URL（如有变更）                                                                                                                                                                                     │
│ - prompts/ 迁移到顶层                                                                                                                                                                                                       │
│ - 验证 Node.js spawn 能正确启动 Python Agent                                                                                                                                                                                │
│                                                                                                                                                                                                                             │
│ Phase 10: Data Migration                                                                                                                                                                                                    │
│                                                                                                                                                                                                                             │
│ - scripts/migrate-sqlite-to-pg.ts                                                                                                                                                                                           │
│   - 读取 SQLite → Prisma createMany 写入 PostgreSQL                                                                                                                                                                         │
│   - 迁移顺序：users → conversations → messages → tasks                                                                                                                                                                      │
│   - 数据转换：TEXT 日期 → Date, TEXT JSON → Json, TEXT enum → Prisma enum                                                                                                                                                   │
│ - 行数验证、FK 完整性检查                                                                                                                                                                                                   │
│                                                                                                                                                                                                                             │
│ Phase 11: Integration Testing & Polish                                                                                                                                                                                      │
│                                                                                                                                                                                                                             │
│ - 端到端测试：注册 → 登录 → 创建会话 → 发送消息 → 流式接收 → 切换会话 → 删除会话                                                                                                                                            │
│ - 文件上传 → Agent 处理 → 返回结果                                                                                                                                                                                          │
│ - 中断正在运行的 Agent                                                                                                                                                                                                      │
│ - 多标签页 Socket.IO 隔离                                                                                                                                                                                                   │
│ - Rate limiting 配置                                                                                                                                                                                                        │
│ - Graceful shutdown                                                                                                                                                                                                         │
│ - 性能对比测试                                                                                                                                                                                                              │
│                                                                                                                                                                                                                             │
│ Phase 12: Cleanup                                                                                                                                                                                                           │
│                                                                                                                                                                                                                             │
│ - 删除 backend/ 目录                                                                                                                                                                                                        │
│ - 更新启动脚本                                                                                                                                                                                                              │
│ - 删除 requirements.txt 中 FastAPI/Uvicorn 等已不需要的依赖                                                                                                                                                                 │
│                                                                                                                                                                                                                             │
│ ---                                                                                                                                                                                                                         │
│ Key Dependencies (server/package.json)                                                                                                                                                                                      │
│                                                                                                                                                                                                                             │
│ fastify, @fastify/cors, @fastify/jwt, @fastify/multipart, @fastify/rate-limit                                                                                                                                               │
│ prisma, @prisma/client                                                                                                                                                                                                      │
│ ioredis, bullmq                                                                                                                                                                                                             │
│ socket.io                                                                                                                                                                                                                   │
│ pino, pino-pretty                                                                                                                                                                                                           │
│ zod                                                                                                                                                                                                                         │
│ bcryptjs, jsonwebtoken, uuid                                                                                                                                                                                                │
│ better-sqlite3 (仅迁移脚本用)                                                                                                                                                                                               │
│ typescript, tsx, @types/*                                                                                                                                                                                                   │
│                                                                                                                                                                                                                             │
│ ---                                                                                                                                                                                                                         │
│ Verification Plan                                                                                                                                                                                                           │
│                                                                                                                                                                                                                             │
│ 1. 单元测试: 每个 service 的核心方法（auth, conversation, chat, agent-manager）                                                                                                                                             │
│ 2. 集成测试: API 端点 + DB + Redis 联动                                                                                                                                                                                     │
│ 3. 前端兼容性: 不修改任何前端代码，验证所有功能正常                                                                                                                                                                         │
│ 4. 性能测试: 会话切换延迟（目标: < 200ms with cache vs 当前 > 1s）                                                                                                                                                          │
│ 5. 并行 Agent: 同一会话启动 2+ SubAgent，验证消息路由正确                                                                                                                                                                   │
│ 6. 容错测试: Agent 崩溃、Redis 断连、DB 超时场景                                                                                                                                                                            │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

Now let me write the seed script and do a final check on all files. Let me also write a socket/namespaces.ts placeholder.

● Write(server\src\socket\namespaces.ts)
  ⎿  PreToolUse:Write hook error
  ⎿  Wrote 1 lines to server\src\socket\namespaces.ts
      1 /**
      2  * Socket.IO namespace definitions
      3  */
      4 export const NAMESPACES = {
      5   /** Client (frontend) namespace */
      6   CLIENT: '/client',
      7   /** Agent (subprocess) namespace */
      8   AGENT: '/agent',
      9 } as const;

● Write(server\scripts\seed.ts)
  ⎿  PreToolUse:Write hook error
  ⎿  Wrote 1 lines to server\scripts\seed.ts
       1 /**
       2  * Seed script: Create initial admin user
       3  *
       4  * Usage: npx tsx scripts/seed.ts
       5  */
       6 import 'dotenv/config';
       7 import { PrismaClient } from '@prisma/client';
       8 import bcrypt from 'bcryptjs';
       9 
      10 async function main() {

● Now let me do a review of the entire server codebase structure to verify completeness.

● Bash(find /c/Users/62411/Project/LLMProjects/mcp-autotest/server -type f -name "*.ts" -o -name "*.json" -o -name "*.prisma" -o -name "*.env*" | sort)
  ⎿  PreToolUse:Bash hook error
  ⎿  /c/Users/62411/Project/LLMProjects/mcp-autotest/server/.env
     /c/Users/62411/Project/LLMProjects/mcp-autotest/server/.env.example
     /c/Users/62411/Project/LLMProjects/mcp-autotest/server/node_modules/.package-lock.json
     … +3244 lines (ctrl+o to expand)

● It seems npm install already ran! Let me check just the source files:

● Bash(find /c/Users/62411/Project/LLMProjects/mcp-autotest/server/src -type f -name "*.ts" | sort)
  ⎿  PreToolUse:Bash hook error
  ⎿  /c/Users/62411/Project/LLMProjects/mcp-autotest/server/src/agent/agent-manager.ts
     /c/Users/62411/Project/LLMProjects/mcp-autotest/server/src/agent/process-spawner.ts
     /c/Users/62411/Project/LLMProjects/mcp-autotest/server/src/agent/types.ts
     … +38 lines (ctrl+o to expand)

● All 41 TypeScript source files are created. Since npm already ran (likely from the background task), let me try to run the TypeScript check.

● build-error-resolver(Fix TypeScript build errors)
  ⎿  PreToolUse:Task hook error
  ⎿  Backgrounded agent (↓ to manage · ctrl+o to expand)

● While the build error resolver works in the background, let me also read the existing agent_service.py carefully - I need to make sure I capture all the SSE event types and the exact request/response formats correctly.   

● Read 1 file (ctrl+o to expand)
  ⎿  PreToolUse:Read hook error
  ⎿  PreToolUse:Read hook error

● Good. The implementation matches. Now let me check the build error resolver progress.

● Task Output aa46e88
  ⎿  PreToolUse:TaskOutput hook error
  ⎿  Task is still running…

● The build error resolver is still working with 52 tool invocations. Let me check its progress.

● Read 2 files (ctrl+o to expand)
  ⎿  PreToolUse:Bash hook error
  ⎿  PreToolUse:Read hook error

● Let me wait for it to complete.

● Task Output aa46e88
  ⎿  PreToolUse:TaskOutput hook error
  ⎿  Read output (ctrl+o to expand)

● The build error resolver completed. Let me check what it found and whether the build is now clean.

● Bash(cd /c/Users/62411/Project/LLMProjects/mcp-autotest/server && npx tsc --noEmit 2>&1 | head -100)
  ⎿  PreToolUse:Bash hook error
  ⎿  src/modules/auth/auth.service.ts(10,15): error TS2305: Module '"@prisma/client"' has no exported member 'UserRole'.
     src/modules/auth/auth.service.ts(10,25): error TS2305: Module '"@prisma/client"' has no exported member 'UserStatus'.
     src/modules/chat/chat.service.ts(31,31): error TS2345: Argument of type 'string | null | undefined' is not assignable to parameter of type 'string'.
     … +17 lines (ctrl+o to expand)
  ⎿  (timeout 1m)
  ⎿  You've hit your limit · resets 7pm (Asia/Hong_Kong)

✻ Cogitated for 23m 18s

● Background command "Install server npm dependencies" completed (exit code 0)
  ⎿  You've hit your limit · resets 7pm (Asia/Hong_Kong)

● Agent "Fix TypeScript build errors" completed
  ⎿  You've hit your limit · resets 7pm (Asia/Hong_Kong)

───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────❯                                                                                                                                                                                                                              ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
  ⏵⏵ accept edits on (shift+Tab to cycle) · 50 files +7 -0